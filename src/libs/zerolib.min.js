class ZeroLib{constructor(_url){this._init=this._init.bind(this);this._connect=this._connect.bind(this);this._send=this._send.bind(this);this._response=this._response.bind(this);this.cmd=this.cmd.bind(this);this.onEvent=this.onEvent.bind(this);this.onOpen=this.onOpen.bind(this);this.onClose=this.onClose.bind(this);this.onMessage=this.onMessage.bind(this);this.url=_url;this.pendingCbs={};this.next_message_id=0;this.wrapper_nonce=document.location.href.replace(/.*wrapper_nonce=([A-Za-z0-9]+).*/,'$1');this._connect();this._init()}_log(){let args;args=1<=arguments.length?[].slice.call(arguments,0):[];return console.log.apply(console,['[ZeroLib]'].concat([].slice.call(args)))}_init(){return this}_connect(){this.target=window.parent;window.addEventListener('message',this.onMessage,false);return this.cmd('innerReady')}_send(_message,_callback){if(_callback===null){_callback=null}_message.wrapper_nonce=this.wrapper_nonce;_message.id=this.next_message_id;this.next_message_id+=1;this.target.postMessage(_message,'*');if(_callback){return this.pendingCbs[_message.id]=_callback}}_response(to,result){const cmd='response';return this._send({cmd,to,result})}cmd(cmd,params,_cb){if(params===null){params={}}if(typeof _cb==='undefined'){return new Promise((resolve,reject)=>{this._send({cmd,params},(_res)=>{if(_res&&_res.error){reject(_res.error)}else{resolve(_res)}})})}return this._send({cmd,params},_cb)}onEvent(_event,_message){this._log(`Unknown event [ ${ _event } ]`,_message)}onOpen(){this._log('WebSocket connected successfully.');this.cmd('wrapperSetViewport','width=device-width, initial-scale=1.0');this._log('Viewport initialized (for mobile support).')}onClose(){this._log('WebSocket has been disconnected.')}onMessage(e){const message=e.data;const cmd=message.cmd;if(cmd==='response'){if(typeof this.pendingCbs[message.to]!=='undefined'){return this.pendingCbs[message.to](message.result)}else{return this._log(`WebSocket callback not found`,message,this.pendingCbs)}}else if(cmd==='wrapperReady'){return this.cmd('innerReady')}else if(cmd==='ping'){return this._response(message.id,'pong')}else if(cmd==='wrapperOpenedWebsocket'){return this.onOpen()}else if(cmd==='wrapperClosedWebsocket'){return this.onClose()}else{return this.onEvent(cmd,message)}}bm(){return{ping:function(){return new Promise((resolve,reject)=>{if(!resolve){return reject('Oops!')}resolve('pong')})}}}ipfs(){return{ping:function(){return new Promise((resolve,reject)=>{if(!resolve){return reject('Oops!')}resolve('pong')})}}}web3(){return{ping:function(){return new Promise((resolve,reject)=>{if(!resolve){return reject('Oops!')}resolve('pong')})}}}}window.ZeroLib=ZeroLib;
